<div class="container mt-2 mb-2">
  <div class="card card-body col-lg-8 offset-lg-2 bg-light">
    <%= form_with url:@url, method: @method, local: true, html: {autocomplete: 'off'} do |f| %>
      <%= f.hidden_field :id, value: @kigurumi.id %>
      <div class="form-group row">
        <label class="col-sm-4 control-label"><b>所有者</b></label>
        <div class="input-group col-sm-8 p-0">
          <%= f.text_field :person_name, value: @kigurumi.owner&.name, id: :personName, class: ['auto_complete', 'form-control'] %>
          <div class="input-group-prepend">
            <span class="input-group-text">@</span>
          </div>
          <%= f.text_field :twitter, value: @kigurumi.owner&.twitter, id: :twitter, class: ['auto_complete', 'form-control'] %>
        </div>
      </div>
      <div class="row">
        <% if !@kigurumi.persisted? %>
          <div id="kigurumis" class="col-sm-8 offset-sm-4 alert alert-success">
            <h5>既に登録されている着ぐるみ</h5>
            <ul></ul>
          </div>
        <% end %>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 control-label"><b>キャラクター名</b></label>
        <%= f.text_field :character_name, value: @kigurumi.character&.name, id: :characterName, class: ['auto_complete', 'col-sm-8', 'form-control'] %><br>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 control-label"><b>作品名</b></label>
        <%= f.text_field :work_name, value: @kigurumi.character&.work&.name, id: :workName, class: ['auto_complete', 'col-sm-8', 'form-control'] %><br>
      </div>
      <div class="form-group row">
        <label  class="col-sm-4 control-label"><b>工房</b></label>
        <%= f.select :factory_id, options_for_select([['', '']] + Factory.all.map{|factory| [factory.name, factory.id]}, @kigurumi.factory_id), {}, {id: :factoryId, class: ['form-control', 'col-sm-8']} %><br>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 control-label"><b>製作者</b></label>
        <div class="input-group col-sm-8 p-0">
          <%= f.text_field :customizer_name, value: @kigurumi.customizer&.name, id: :customizerName, class: ['auto_complete', 'form-control'] %>
          <div class="input-group-prepend">
            <span class="input-group-text">@</span>
          </div>
          <%= f.text_field :customizer_twitter, value: @kigurumi.customizer&.twitter, id: :customizerTwitter, class: ['auto_complete', 'form-control'] %>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 control-label"><b>以前の所有者</b></label>
        <div class="input-group col-sm-8 p-0">
          <%= f.text_field :previous_owner_name, value: @kigurumi.previous_owner&.name, id: :previousOwnerName, class: ['auto_complete', 'form-control'] %>
          <div class="input-group-prepend">
            <span class="input-group-text">@</span>
          </div>
          <%= f.text_field :previous_owner_twitter, value: @kigurumi.previous_owner&.twitter, id: :previousOwnerTwitter, class: ['auto_complete', 'form-control'] %>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 control-label"><b>お披露目年</b></label>
        <%= f.text_field :show_year, value: @kigurumi.show_year, class: ['col-sm-8', 'form-control'] %><br>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 control-label"><b>備考</b></label>
        <%= f.text_area :remarks, value: @kigurumi.remarks, class: ['col-sm-8', 'form-control'] %><br>
      </div>
      <div class="form-group row">
      <label class="col-sm-4 control-label"><b>画像</b></label>
      <div class="col-sm-8 p-0">
        <% (1..3).each do |i| %>
          <%= f.text_field 'kigurumi_images[]', value: @kigurumi.kigurumi_images[i]&.url, class: 'form-control'  %><br>
        <% end %>
        </div>
      </div>

      <div class="form-group row">
        <%= f.submit '登録', class:'btn btn-danger btn-block col-sm-4 offset-sm-4' %>
      </div>
    <% end %>
  </div>
</div>

<script>
$('#kigurumis').css('display', 'none');

autoComplete.personChain({
  name: '#personName.auto_complete',
  twitter: '#twitter.auto_complete',
  nameUrl: '<%= auto_complete_people_path %>',
  nameVal: 'name',
  twitterUrl: '<%= auto_complete_twitter_people_path %>',
  twitterVal: 'twitter',
  displayVal: 'name_with_twitter',
  onSelected: function(name, twitter){
    $.get({
      url: '<%= kigurumis_people_path %>',
      dataType: 'json',
    data: {
      name: name.val(),
      twitter: twitter.val()
  }
  }).done(function(data){
    $('#kigurumis li').remove();
    $.each(data, function(id, kigurumi){
      $('#kigurumis ul').append($('<li>').text(kigurumi.character.name));
    });
    $('#kigurumis').slideUp('slow');
    $('#kigurumis').slideDown('slow');
  });
  }
});

autoComplete.personChain({
  name: '#previousOwnerName.auto_complete',
  twitter: '#previousOwnerTwitter.auto_complete',
  nameUrl: '<%= auto_complete_people_path %>',
  nameVal: 'name',
  twitterUrl: '<%= auto_complete_twitter_people_path %>',
  twitterVal: 'twitter',
  displayVal: 'name_with_twitter',
  onSelected: function(name, twitter){
    $.get({
      url: '<%= kigurumis_people_path %>',
      dataType: 'json',
      data: {
        name: name.val(),
        twitter: twitter.val()
      }  
    });
  }
});

autoComplete.personChain({
  name: '#customizerName.auto_complete',
  twitter: '#customizerTwitter.auto_complete',
  nameUrl: '<%= auto_complete_people_path %>',
  nameVal: 'name',
  twitterUrl: '<%= auto_complete_twitter_people_path %>',
  twitterVal: 'twitter',
  displayVal: 'name_with_twitter',
  onSelected: function(name, twitter){
    $.get({
      url: '<%= kigurumis_people_path %>',
      dataType: 'json',
      data: {
        name: name.val(),
        twitter: twitter.val()
      }
    });
  }
});

autoComplete.characterWorkChain({
  character: '#characterName.auto_complete',
  work: '#workName.auto_complete',
  characterUrl: '<%= auto_complete_characters_path %>', 
  characterVal: 'name',
  workUrl: '<%= auto_complete_works_path %>',
  workVal: 'name',
  characterDisplayVal: 'name_with_work'
});
</script>